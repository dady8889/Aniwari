@using Aniwari.BL.Repositories;
@using Aniwari.BL.Services;
@using Aniwari.Watchlist;

@page "/watchlist"

@inject IJSRuntime JSRuntime

@inject INyaaService NyaaService
@inject ISettingsService SettingsService
@inject IAnimeRepository AnimeRepository

@inherits ReactiveComponentBase

@if (Store == null) return;

<div class="aniwari-content watchlist">

    <TorrentPicker Torrents="selectedTorrents" OnTorrentSelected="OnTorrentSelected" />

    <div class="aniwari-card @(torrentPickerShown)">
        @{
            var lastAnime = watchingAnime.LastOrDefault();
        }

        @if (lastAnime == null)
        {
            <div class="aniwari-list-item watchlist-item noanime">You are not watching any anime</div>
        }
        else
        {
            <Virtualize Context="anime" Items="watchingAnime">
                <Accordion @key="anime.Id">
                    <AccordionHeader>
                        <div class="aniwari-list-item watchlist-item @(context.Expanded ? "expanded" : "")">
                            <div class="watchlist-item__title">
                                @anime.Title
                            </div>
                            <div class="watchlist-item__episodes">
                                <div>
                                    @anime.GetWatchedEpisodes().Count()
                                </div>
                                <div>
                                    /
                                </div>
                                <div>
                                    @(anime.EpisodesCount?.ToString() ?? "?")
                                </div>
                            </div>
                        </div>
                    </AccordionHeader>
                    <AccordionBody>
                        <div class="aniwari-list-detail">
                            @if (anime.EpisodesCount != null)
                            {
                                @foreach (int ep in Enumerable.Range(1, anime.EpisodesCount.Value))
                                {
                                    <div class="aniwari-list-item episode">
                                        <div class="episode__title">Episode @ep</div>
                                        <input class="episode__button" type="button" value="Search" @onclick="() => SearchAnime(anime, ep)" />
                                    </div>
                                }
                            }
                        </div>
                    </AccordionBody>
                </Accordion>

                @if (anime != lastAnime)
                {
                    <hr>
                }
            </Virtualize>
        }
    </div>
</div>

@code {
    private SettingsStore? Store;
    private List<SettingsStore.Anime> watchingAnime = new();
    private List<NyaaAnime>? selectedTorrents = null;
    private int savedScroll = 0;

    private string torrentPickerShown => selectedTorrents != null ? "hidden" : "";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        Store = SettingsService.GetStore();
        watchingAnime = Store.Animes.Where(x => x.Watching).ToList();
    }

    private async Task SearchAnime(SettingsStore.Anime anime, int episode)
    {
        savedScroll = await JSRuntime.InvokeAsync<int>("getDocumentScrollTop");
        selectedTorrents = await NyaaService.GetAnime(anime.Title, episode);
    }

    private async Task OnTorrentSelected(TorrentPicker.TorrentSelectedEventArgs args)
    {
        selectedTorrents = null;
        StateHasChanged();
        await Task.Delay(150);
        await JSRuntime.InvokeVoidAsync("setDocumentScrollTop", savedScroll, true);
        savedScroll = 0;
    }
}